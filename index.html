<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>J.A.R.V.I.S. AI Assistant</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <style>
       /* (keeping your full CSS here unchanged) */
   </style>
</head>
<body class="bg-gray-900 text-cyan-200">

   <!-- UI stays the same -->
   <div id="loading-overlay">
       <div class="spinner"></div>
   </div>

   <div id="jarvis-container" class="w-full h-screen p-4 flex flex-col items-center justify-between relative opacity-0 transition-opacity duration-1000">
       <header class="w-full max-w-7xl flex justify-between items-center hud-element glow-border p-2 rounded-lg">
           <h1 class="text-2xl font-bold glow-text">J.A.R.V.I.S. INTERFACE</h1>
           <div class="text-right">
               <div id="time" class="text-xl"></div>
               <div id="date" class="text-sm"></div>
           </div>
       </header>

       <main class="w-full flex-grow flex items-center justify-center my-4">
           <div id="orb-container">
               <div id="orb">
                   <div class="ring"></div>
                   <div class="ring"></div>
                   <div class="ring"></div>
                   <div id="core"></div>
               </div>
           </div>
       </main>

       <div class="w-full max-w-4xl h-48 flex gap-4">
           <div id="log-container" class="flex-grow hud-element glow-border p-4 rounded-lg overflow-y-auto"></div>
           <div id="status-container" class="w-64 hud-element glow-border p-4 rounded-lg flex flex-col justify-between">
               <div>
                   <h2 class="text-lg glow-text border-b border-[var(--border-color)] pb-1 mb-2">SYSTEM STATUS</h2>
                   <p id="status-text" class="text-center text-xl font-semibold">STANDBY</p>
               </div>
                <button id="start-btn" class="w-full bg-cyan-500/20 hover:bg-cyan-500/40 text-white font-bold py-2 px-4 rounded-lg glow-border transition-all duration-300">
                   ACTIVATE J.A.R.V.I.S.
               </button>
           </div>
       </div>
   </div>

   <script type="module">
       // --- DOM Elements ---
       const startBtn = document.getElementById('start-btn');
       const statusText = document.getElementById('status-text');
       const logContainer = document.getElementById('log-container');
       const orb = document.getElementById('orb');
       const timeEl = document.getElementById('time');
       const dateEl = document.getElementById('date');
       const loadingOverlay = document.getElementById('loading-overlay');
       const jarvisContainer = document.getElementById('jarvis-container');

       // --- Speech Recognition & Synthesis ---
       const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
       const recognition = SpeechRecognition ? new SpeechRecognition() : null;
       const synth = window.speechSynthesis;
       let voices = [];
       let jarvisVoice = null;
       let isListening = false;
       let isActivated = false;

       // --- ChatGPT API Configuration ---
       const OPENAI_API_KEY = "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"; // put your key here
       const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";

       // --- System Initialization ---
       window.onload = () => {
           if (!SpeechRecognition) {
               alert("Sorry, your browser doesn't support the Web Speech API. Please try Chrome or Edge.");
               return;
           }
           if (!synth) {
               alert("Sorry, your browser doesn't support the Speech Synthesis API.");
               return;
           }

           setupVoices();
           if (synth.onvoiceschanged !== undefined) {
               synth.onvoiceschanged = setupVoices;
           }

           setInterval(updateDateTime, 1000);
           updateDateTime();

           // Fade in UI
           setTimeout(() => {
               loadingOverlay.style.opacity = '0';
               jarvisContainer.style.opacity = '1';
               setTimeout(() => loadingOverlay.style.display = 'none', 500);
           }, 1000);
       };

       function setupVoices() {
           voices = synth.getVoices();
           jarvisVoice = voices.find(voice => voice.name === 'Google UK English Male') ||
                         voices.find(voice => voice.lang === 'en-GB' && voice.name.includes('Male')) ||
                         voices.find(voice => voice.lang.startsWith('en-') && voice.name.includes('Male')) ||
                         voices[0];
       }

       function updateDateTime() {
           const now = new Date();
           timeEl.textContent = now.toLocaleTimeString();
           dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
       }

       function speak(text, onEndCallback = () => {}) {
           if (synth.speaking) return;
           if (text !== '') {
               updateStatus('Speaking');
               const utterance = new SpeechSynthesisUtterance(text);
               utterance.voice = jarvisVoice;
               utterance.pitch = 0.9;
               utterance.rate = 1.1;
               utterance.onend = () => {
                   updateStatus('Thinking');
                   if(onEndCallback) onEndCallback();
                   if(isActivated) startListening();
               };
               synth.speak(utterance);
           }
       }

       function addLog(speaker, message) {
           const logEntry = document.createElement('p');
           logEntry.innerHTML = `<strong class="glow-text ${speaker === 'J.A.R.V.I.S.' ? 'text-cyan-400' : 'text-white'}">${speaker}:</strong> ${message}`;
           logContainer.appendChild(logEntry);
           logContainer.scrollTop = logContainer.scrollHeight;
       }

       function updateStatus(text) {
           statusText.textContent = text.toUpperCase();
           if (text.toLowerCase() === 'listening') {
               orb.classList.add('listening');
           } else {
               orb.classList.remove('listening');
           }
       }

       function startListening() {
           if (isListening || synth.speaking) return;
           try {
               recognition.start();
               isListening = true;
               updateStatus('Listening');
           } catch(e) {
               console.error("Recognition start error:", e);
               isListening = false;
           }
       }

       function setupRecognition() {
           recognition.continuous = false;
           recognition.lang = 'en-US';
           recognition.interimResults = false;

           recognition.onstart = () => {
               isListening = true;
               updateStatus('Listening');
           };

           recognition.onresult = (event) => {
               const transcript = event.results[0][0].transcript.trim().toLowerCase();
               addLog('User', transcript);
               processCommand(transcript);
           };

           recognition.onerror = (event) => {
               console.error(`Speech recognition error: ${event.error}`);
           };

           recognition.onend = () => {
               isListening = false;
               if (isActivated && !synth.speaking) {
                  updateStatus('Thinking');
                  setTimeout(() => {
                      if(isActivated) startListening();
                  }, 500);
               } else if (!isActivated) {
                   updateStatus('Deactivated');
               }
           };
       }

       // --- Command Processing ---
       async function processCommand(command) {
           updateStatus('Processing');

           if (command.includes('shutdown') || command.includes('goodbye') || command.includes('deactivate')) {
               speak("Goodbye, sir.", () => {
                    isActivated = false;
                    startBtn.textContent = 'ACTIVATE J.A.R.V.I.S.';
                    updateStatus('Deactivated');
               });
               return;
           }

           if (command.includes('what time is it')) {
               const time = new Date().toLocaleTimeString();
               speak(`The current time is ${time}`);
               addLog('J.A.R.V.I.S.', `The current time is ${time}.`);
               return;
           }

           if (command.includes('what is the date')) {
               const date = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
               speak(`Today is ${date}`);
               addLog('J.A.R.V.I.S.', `Today is ${date}.`);
               return;
           }

           if (command.startsWith('search for')) {
               const query = command.substring('search for'.length).trim();
               speak(`Searching Google for ${query}`);
               addLog('J.A.R.V.I.S.', `Searching Google for: ${query}.`);
               window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
               return;
           }

           if (command.includes('tell me a joke')) {
               const jokes = [
                   "Why don't scientists trust atoms? Because they make up everything!",
                   "I told my wife she was drawing her eyebrows too high. She looked surprised.",
                   "Why did the scarecrow win an award? Because he was outstanding in his field."
               ];
               const joke = jokes[Math.floor(Math.random() * jokes.length)];
               speak(joke);
               addLog('J.A.R.V.I.S.', joke);
               return;
           }

           // --- NEW: Fallback to ChatGPT ---
           try {
               const gptResponse = await getChatGPTResponse(command);
               speak(gptResponse);
               addLog('J.A.R.V.I.S.', gptResponse);
           } catch (error) {
               console.error("Error fetching from ChatGPT:", error);
               const errorMessage = "I'm sorry, sir. I seem to be having trouble connecting to my mainframe.";
               speak(errorMessage);
               addLog('J.A.R.V.I.S.', errorMessage);
           }
       }

       // --- ChatGPT API Call ---
       async function getChatGPTResponse(prompt, retries = 3, delay = 1000) {
           const payload = {
               model: "gpt-4o-mini",
               messages: [
                   {
                       role: "system",
                       content: "You are J.A.R.V.I.S., Tony Stark's AI assistant. Your responses should be concise, helpful, and slightly witty. Always address the user as 'sir'."
                   },
                   {
                       role: "user",
                       content: prompt
                   }
               ]
           };

           try {
               const response = await fetch(OPENAI_API_URL, {
                   method: "POST",
                   headers: {
                       "Authorization": `Bearer ${OPENAI_API_KEY}`,
                       "Content-Type": "application/json"
                   },
                   body: JSON.stringify(payload)
               });

               if (!response.ok) {
                   if (response.status === 429 && retries > 0) {
                       await new Promise(res => setTimeout(res, delay));
                       return getChatGPTResponse(prompt, retries - 1, delay * 2);
                   }
                   throw new Error(`API responded with status: ${response.status}`);
               }

               const result = await response.json();
               return result.choices[0].message.content;
           } catch (error) {
               if (retries > 0) {
                   await new Promise(res => setTimeout(res, delay));
                   return getChatGPTResponse(prompt, retries - 1, delay * 2);
               }
               throw error;
           }
       }

       // --- Event Listeners ---
       startBtn.addEventListener('click', () => {
           if (!isActivated) {
               isActivated = true;
               startBtn.textContent = 'DEACTIVATE J.A.R.V.I.S.';
               addLog('System', 'J.A.R.V.I.S. activated.');
               speak("How may I help you, sir?", () => {
                   startListening();
               });
               setupRecognition();
           } else {
               isActivated = false;
               startBtn.textContent = 'ACTIVATE J.A.R.V.I.S.';
               addLog('System', 'J.A.R.V.I.S. deactivated.');
               recognition.stop();
               updateStatus('Deactivated');
           }
       });
   </script>
</body>
</html>
